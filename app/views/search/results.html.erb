  <%= form_with url: search_index_path, method: :get, local: true do |f| %>
    <div class="mb-2">
      <label class="form-label">タイトルで検索：</label>
      <%= f.text_field :keyword, placeholder: "動画タイトルを入力", class: "form-control" %>
    </div>

    <div class="mb-2">
      <label class="form-label">タグで絞り込み：</label>
      <%= f.select :tag, options_for_select(Video.tag_counts_on(:tags).pluck(:name)), { include_blank: "全て" }, { class: "form-select" } %>
    </div>

    <div class="mb-4">
      <%= f.submit "検索", class: "btn btn-outline-primary" %>
    </div>
  <% end %>
  
  <div class="container my-5">
  <div class="row">
    
    <div class="col-lg-12">
      
      <!-- タイトル表示 -->
      <h2 class="mb-4">
        <% if params[:keyword].present? %>
          「<%= params[:keyword] %>」の検索結果
        <% elsif params[:tag].present? %>
          タグ「<%= params[:tag] %>」の検索結果
        <% else %>
          全動画リスト
        <% end %>
        (<%= @videos_count %> 件)
      </h2>
      
      <!-- ソートフォーム -->
      <%= form_with url: search_index_path, method: :get, local: true, class: "mb-3" do %> 
        
        <!-- 検索条件を引き継ぐための隠しフィールド -->
        <%= hidden_field_tag :keyword, params[:keyword] %>
        <%= hidden_field_tag :tag, params[:tag] %>
        
        <%= select_tag :sort,
            options_for_select([
              ["視聴回数 多い順", "watch_desc"],
              ["視聴回数 少ない順", "watch_asc"],
              ["登録順 新しい順", "created_desc"],
              ["登録順 古い順", "created_asc"]
            ], params[:sort]),
            class: "form-select w-auto d-inline-block",
            onchange: "this.form.submit();" %>
      <% end %>

      <!-- 動画リスト表示 -->
      <% if @videos.empty? %>
        <div class="alert alert-warning" role="alert">
          該当する動画は見つかりませんでした。
        </div>
      <% else %>
        <div class="card shadow-sm">
          <div class="card-body">
            
            <% @videos.each.with_index(1) do |video, index| %>
              
              <div class="d-flex align-items-center mb-3 p-3 border rounded">

                <!-- サムネイル (左側) -->
                <div class="me-4 flex-shrink-0">
                  <% if video.video_id.present? %>
                    <%= link_to video_path(video) do %>
                      <img src="https://img.youtube.com/vi/<%= video.video_id %>/mqdefault.jpg" 
                            alt="<%= video.title %>のサムネイル" 
                            class="img-fluid rounded shadow-sm"
                            style="width: 160px; height: auto;">
                    <% end %>
                  <% else %>
                    <div class="rounded bg-light text-secondary d-flex align-items-center justify-content-center border" 
                          style="width: 160px; height: 90px; font-size: 0.9em;">
                      NO IMAGE
                    </div>
                  <% end %>
                </div>

                <!-- タイトルと情報 (右側) -->
                <div class="flex-grow-1">
                  <h5 class="mb-2">
                    <%= link_to video.title, video_path(video), class: "text-decoration-none text-dark fw-bold" %>
                  </h5>
                  
                  <!-- タグリスト -->
                  <div class="mb-2">
                    <% video.tag_list.each do |tag| %>
                      <%= link_to tag, search_index_path(tag: tag), class: "badge bg-secondary text-decoration-none me-1" %>
                    <% end %>
                  </div>

                  <!-- 視聴回数 -->
                  <span class="badge bg-success fs-6">
                    視聴回数 <%= Watch.where(video: video).sum(:watched_count) %>回
                  </span>
                </div>
              </div>
            <% end %>
            
          </div>
        </div>
      <% end %>
    </div>

  </div>
</div>