<h1><%= @video.title %></h1>

<% if @video.video_id.present? %>
  <div class="ratio ratio-16x9 mb-4 shadow-lg rounded">
    <div id="youtube-player"></div>
  </div>
<% else %>
  <div class="alert alert-danger" role="alert">
    å‹•ç”»IDãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚
  </div>
<% end %>

<p class="mb-4">
  <span class="badge bg-primary fs-5">
    è¦–è´å›æ•°: <%= Watch.where(video: @video).sum(:watched_count) %>å›
  </span>
  <%= link_to "YouTubeã§è¦‹ã‚‹", "https://www.youtube.com/watch?v=#{@video.video_id}", target: "_blank", class: "btn btn-danger btn-sm ms-3" %>
</p>
<hr>

<script>
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var player;
  var hasCounted = false; 

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('youtube-player', {
      videoId: '<%= @video.video_id %>',
      playerVars: {
        'autoplay': 0,
        'controls': 1,
        'showinfo': 0,
        'rel': 0,
        'enablejsapi': 1 
      },
      events: {
        'onStateChange': onPlayerStateChange 
      }
    });
  }

  function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING && !hasCounted) {
      
      // è¦–è´å›æ•°æ›´æ–°ã®ãŸã‚ã®éåŒæœŸãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢æ•°ã‚’å®Ÿè¡Œ
      updateWatchCount();
      hasCounted = true;
    }
  }

  // è¦–è´å›æ•°æ›´æ–°ã®ãŸã‚ã®éåŒæœŸãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢æ•°
  function updateWatchCount() {
    const videoId = '<%= @video.id %>';
    // Railsã®CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    // /videos/:id/watched (POST) ã«éåŒæœŸã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    fetch(`/videos/${videoId}/watched`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken // Railsã§ã®èªè¨¼å¯¾å¿œ
      }
    })
    .then(response => {
      if (response.ok) {
        console.log('è¦–è´å›æ•°ã‚’æ­£å¸¸ã«ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã—ãŸã€‚');
      } else {
        console.error('è¦–è´å›æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', response.statusText);
      }
    })
    .catch(error => {
      console.error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šè¦–è´å›æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    });
  }
</script>

<div class="mt-5 pt-3 border-top">
  <h3 class="mb-4 fw-bold">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</h3>

  <% if user_signed_in? %>
    <%# ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  (éåŒæœŸ UJS/Turbo å¯¾å¿œ) %>
    <%= form_with(model: [@video, @post], url: video_posts_path(@video), data: { remote: true, turbo: true }, class: "mb-5", id: "new_post_form") do |f| %>
      
      <%# ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ %>
      <div id="post_errors">
      </div>

      <div class="mb-3">
        <%= f.text_area :content, 
              rows: 3, 
              class: "form-control", 
              placeholder: "ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (140æ–‡å­—ã¾ã§)",
              maxlength: 140 %>
      </div>
      <%= f.submit "æŠ•ç¨¿ã™ã‚‹", class: "btn btn-primary" %>
    <% end %>
  <% else %>
    <div class="alert alert-info text-center" role="alert">
      ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯<%= link_to 'Googleãƒ­ã‚°ã‚¤ãƒ³', user_google_oauth2_omniauth_authorize_path, class: 'alert-link' %>ãŒå¿…è¦ã§ã™ã€‚
    </div>
  <% end %>

  <h3 class="mb-4 fw-bold mt-5">ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ï¼ˆ<%= @posts.reject { |post| post.content == "YouTubeã§è¦–è´ï¼è‡ªå‹•ç™»éŒ²" }.count %>ä»¶ï¼‰</h3>
  
  <div id="post_list">
    <% if @posts.present? %>
      <%= render partial: 'posts/post', collection: @posts %>
    <% else %>
      <p class="text-muted text-center">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    <% end %>
  </div>

</div>

<br><br>

<hr>
<h3>ã‚¿ã‚°</h3>

<div id="tag-section">
  <% if @video.tag_list.any? %>
    <ul id="tag-list" class="list-unstyled d-flex flex-wrap align-items-center mb-3">
      <% @video.tag_list.each do |tag| %>
        <li class="me-4 mt-2 position-relative tag-list-item" data-tag="<%= tag %>">
          
          <%= link_to tag, search_index_path(tag: tag), 
              class: "badge bg-light text-dark border border-secondary text-decoration-none px-3 py-2 fs-6 fw-normal rounded-pill" %> 
          
          <%# ã‚¿ã‚°å‰Šé™¤ãƒœã‚¿ãƒ³(ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º) %>
          <% if user_signed_in? %>
            <%= link_to remove_tag_video_path(@video, tag: tag),
                        method: :delete,
                        remote: true,
                        class: "delete-tag-btn position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger text-white border border-light d-none text-decoration-none",
                        style: "width: 20px; height: 20px; cursor: pointer; z-index: 10; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);",
                        data: { confirm: "ã‚¿ã‚° '#{tag}' ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" } do %>
              <span aria-hidden="true" style="font-size: 14px; line-height: 1; font-weight: bold;">&times;</span>
            <% end %>
          <% end %>

        </li>
      <% end %>
    </ul>
    
    <%# ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³(ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º) %>
    <% if user_signed_in? %>
      <button id="toggle-edit-mode-btn" class="btn btn-outline-secondary btn-sm mb-3">ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
    <% end %>

  <% else %>
    <p id="no-tags-message" class="text-muted">ã‚¿ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
  <% end %>
</div>

<%# ã‚¿ã‚°è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ (ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º) %>
<% if user_signed_in? %>
  <%= form_with(model: @video, url: video_path(@video), method: :patch, local: true, class: "mt-3") do |f| %>
    <div>
      <label class="form-label">æ–°ã—ã„ã‚¿ã‚°è¿½åŠ ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚ŠOKï¼‰</label><br>
      <%= text_field_tag "video[new_tags]", nil, class: "form-control", placeholder: "ä¾‹: ã‚®ãƒ£ã‚°é­”ç¥, é¢æ¥, ãƒ¤ãƒã„ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼" %>
    </div>

    <%= f.submit "ã‚¿ã‚°ã‚’è¿½åŠ ", class: "btn btn-success btn-sm mt-2" %>
  <% end %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('toggle-edit-mode-btn');
    
    if (toggleBtn) { 
      const deleteBtns = document.querySelectorAll('.delete-tag-btn');
      
      toggleBtn.addEventListener('click', function() {
        const isEditModeActive = this.classList.contains('active');

        deleteBtns.forEach(btn => {
          if (isEditModeActive) {
            btn.classList.add('d-none');
            btn.classList.remove('d-flex');
          } else {
            btn.classList.remove('d-none');
            btn.classList.add('d-flex');
          }
        });

        if (isEditModeActive) {
          this.textContent = 'ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
          this.classList.remove('active', 'btn-secondary');
          this.classList.add('btn-outline-secondary');
        } else {
          this.textContent = 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†';
          this.classList.add('active', 'btn-secondary');
          this.classList.remove('btn-outline-secondary');
        }
      });
    }
  });
</script>

<hr class="my-5">

<h3>ğŸ¥ é–¢é€£å‹•ç”»</h3>
<% if @related_videos.any? %>
  <div class="row row-cols-1 row-cols-md-3 g-4">
    <% @related_videos.each do |video| %>
      <div class="col">
        <div class="card h-100 shadow-sm">
          <% if video.video_id.present? %>
            <%= link_to video_path(video) do %>
              <img src="https://img.youtube.com/vi/<%= video.video_id %>/mqdefault.jpg" 
                    class="card-img-top" 
                    alt="<%= video.title %>ã®ã‚µãƒ ãƒã‚¤ãƒ«">
            <% end %>
          <% end %>
          <div class="card-body">
            <h5 class="card-title">
              <%= link_to video.title, video_path(video), class: "text-decoration-none text-dark fw-bold" %>
            </h5>
            <p class="card-text small text-muted">
              è¦–è´å›æ•°: <%= Watch.where(video: video).sum(:watched_count) %>å›
            </p>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <p class="text-muted">é–¢é€£ã™ã‚‹ã‚¿ã‚°ã‚’æŒã¤ä»–ã®å‹•ç”»ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
<% end %>