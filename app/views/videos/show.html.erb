<h1><%= @video.title %></h1>

<p class="mb-4">
  <span class="badge bg-primary fs-5">
    è¦–è´å›æ•°: <%= Watch.where(video: @video).sum(:watched_count) %>å›
  </span>
  <%= link_to "YouTubeã§è¦‹ã‚‹", "https://www.youtube.com/watch?v=#{@video.video_id}", target: "_blank", class: "btn btn-danger btn-sm ms-3" %>
</p>
<hr>
<h3>ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>

<% valid_posts = @video.posts.select { |post|
     post.content.present? && post.content != "YouTubeã§è¦–è´ï¼è‡ªå‹•ç™»éŒ²"
   } %>

<% if valid_posts.any? %>
  <% valid_posts.each do |post| %>
    <div>
      <p><%= post.content %></p>

      <% if current_user == post.user %>
        <%= link_to "ç·¨é›†", edit_post_path(post) %> |
        <%= button_to "å‰Šé™¤", post_path(post), method: :delete, data: { confirm: "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" } %>
      <% end %>
    </div>
  <% end %>
<% else %>
  <p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
<% end %>

<%= link_to "ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹", new_video_post_path(@video) %>

<br><br>

<hr>
<h3>ã‚¿ã‚°</h3>

<div id="tag-section">
  <% if @video.tag_list.any? %>
    <ul id="tag-list" class="list-unstyled d-flex flex-wrap align-items-center mb-3">
      <% @video.tag_list.each do |tag| %>
        <li class="me-4 mt-2 position-relative tag-list-item" data-tag="<%= tag %>">
          
          <%= link_to tag, root_path(keyword: tag), 
              class: "badge bg-light text-dark border border-secondary text-decoration-none px-3 py-2 fs-6 fw-normal rounded-pill" %> 
          
          <%= link_to remove_tag_video_path(@video, tag: tag),
                      method: :delete,
                      remote: true,
                      # start-100: è¦ªã®å³ç«¯ã¸é…ç½®
                      # translate-middle: è‡ªèº«ã®ä¸­å¿ƒã‚’åŸºæº–ç‚¹ã«åˆã‚ã›ã‚‹ï¼ˆã“ã‚Œã§è§’ã«åŠåˆ†ä¹—ã‚‹ï¼‰
                      class: "delete-tag-btn position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger text-white border border-light d-none text-decoration-none",
                      style: "width: 20px; height: 20px; cursor: pointer; z-index: 10; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);",
                      data: { confirm: "ã‚¿ã‚° '#{tag}' ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" } do %>
            <span aria-hidden="true" style="font-size: 14px; line-height: 1; font-weight: bold;">&times;</span>
          <% end %>

        </li>
      <% end %>
    </ul>
    
    <button id="toggle-edit-mode-btn" class="btn btn-outline-secondary btn-sm mb-3">ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>

  <% else %>
    <p id="no-tags-message" class="text-muted">ã‚¿ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
  <% end %>
</div>


<%= form_with(model: @video, url: video_path(@video), method: :patch, local: true, class: "mt-3") do |f| %>
  <div>
    <label class="form-label">æ–°ã—ã„ã‚¿ã‚°è¿½åŠ ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚ŠOKï¼‰</label><br>
    <%= text_field_tag "video[new_tags]", nil, class: "form-control", placeholder: "ä¾‹: ã‚®ãƒ£ã‚°é­”ç¥, é¢æ¥, ãƒ¤ãƒã„ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼" %>
  </div>

  <%= f.submit "ã‚¿ã‚°ã‚’è¿½åŠ ", class: "btn btn-success btn-sm mt-2" %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('toggle-edit-mode-btn');
    
    if (toggleBtn) {
      const deleteBtns = document.querySelectorAll('.delete-tag-btn');
      
      toggleBtn.addEventListener('click', function() {
        const isEditModeActive = this.classList.contains('active');

        deleteBtns.forEach(btn => {
          if (isEditModeActive) {
            btn.classList.add('d-none'); // æ¶ˆã™
            btn.classList.remove('d-flex'); // flexã‚‚æ¶ˆã™
          } else {
            btn.classList.remove('d-none'); // è¡¨ç¤ºã™ã‚‹
            btn.classList.add('d-flex'); // flexã§ä¸­å¤®æƒãˆã‚’æœ‰åŠ¹ã«ã™ã‚‹
          }
        });

        if (isEditModeActive) {
          this.textContent = 'ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
          this.classList.remove('active', 'btn-secondary');
          this.classList.add('btn-outline-secondary');
        } else {
          this.textContent = 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†';
          this.classList.add('active', 'btn-secondary');
          this.classList.remove('btn-outline-secondary');
        }
      });
    }
  });
</script>

<hr class="my-5">

<h3>ğŸ¥ é–¢é€£å‹•ç”»</h3>
<% if @related_videos.any? %>
  <div class="row row-cols-1 row-cols-md-3 g-4">
    <% @related_videos.each do |video| %>
      <div class="col">
        <div class="card h-100 shadow-sm">
          <% if video.video_id.present? %>
            <%= link_to video_path(video) do %>
              <img src="https://img.youtube.com/vi/<%= video.video_id %>/mqdefault.jpg" 
                   class="card-img-top" 
                   alt="<%= video.title %>ã®ã‚µãƒ ãƒã‚¤ãƒ«">
            <% end %>
          <% end %>
          <div class="card-body">
            <h5 class="card-title">
              <%= link_to video.title, video_path(video), class: "text-decoration-none text-dark fw-bold" %>
            </h5>
            <p class="card-text small text-muted">
              è¦–è´å›æ•°: <%= Watch.where(video: video).sum(:watched_count) %>å›
            </p>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <p class="text-muted">é–¢é€£ã™ã‚‹ã‚¿ã‚°ã‚’æŒã¤ä»–ã®å‹•ç”»ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
<% end %>